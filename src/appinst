#!/usr/bin/bash

basedir="$PWD"
destdir="$HOME/.local/bin/"
url=""
filepath=""
opt_try=0
# undocumented and not recommended
opt_force=0

error_exit()
{
    test "$1" == "" || printf "$1\n"; echo "abort..."; exit 1
    echo "*** usage :"
    echo "appinst \"https://url/to/file\""
    echo "abort..."
    exit 1
}

download_file()
{
    local tempdir=$(mktemp -d -t appinst-XXXX)
    echo "cmd  : wget -P \"$tempdir\" \"$1\""
    wget -P "$tempdir" "$1"
    for file in "$tempdir"/*; do
        test "$filepath" == "" || error_exit "*** multiple files error"
        test -f "$file" && filepath="$file"
    done
    test -f "$filepath" || error_exit "*** download error"
    echo "file : $filepath"
}

test_file()
{
    filetype=$(file -b "$1")
    echo "type : $filetype"
    if [[ $opt_force != 1 ]] \
    && [[ $filetype != "ELF"* ]] \
    && [[ $filetype != "Bourne-Again shell script"* ]] \
    && [[ $filetype != "Perl script"* ]] \
    && [[ $filetype != "Python script"* ]] \
    && [[ $filetype != "Ruby script"* ]]; then
        error_exit "*** wrong file type"
    fi
}

move_file()
{
    test -f "$1" || error_exit "invalid file"
    test -d "$2" || mkdir -p "$2"
    if [[ $opt_try -eq 0 ]]; then
        echo "cmd  : chmod +x ${1}"
        chmod +x "$1"
        echo "cmd  : mv ${1} ${2}"
        mv "$1" "$2"
    else
        echo "try  : chmod +x ${1}"
        echo "try  : mv ${1} ${2}"
    fi
}

while (($#)); do
    case "$1" in
        -force)
        opt_force=1
        ;;
        -try)
        opt_try=1
        ;;
        *)
        test "$url" == "" || error_exit "*** invalid option"
        url="$1"
        ;;
    esac
    shift
done

if [[ ! -f /usr/bin/wget ]]; then
    echo "*** wget not found"
    echo "install it with :"
    echo "sudo apt install wget"
    echo "abort..."
    exit 1
fi

if [[ "$EUID" == 0 ]]; then
    destdir="/usr/local/bin/"
fi

if [[ $url != "http"* ]]; then
    error_exit
fi

download_file "$url"
test_file "$filepath"
move_file "$filepath" "$destdir"



#!/usr/bin/bash

basedir="$PWD"
url=""
destdir="$HOME/.local/bin/"
force=0
filepath=""

error_exit()
{
    test "$1" == "" || printf "$1"; echo "abort..."; exit 1
    echo "*** usage :"
    echo "appinst \"https://url/to/file\""
    echo "abort..."
    exit 1
}

download_file()
{
    tempdir=$(mktemp -d -t appinst-XXXX)
    wget -P "$tempdir" "$1"
    for file in "$tempdir"/*; do
        test "$filepath" == "" || error_exit "*** multiple files error"
        test -f "$file" && filepath="$file"
    done
}

move_file()
{
    test -f "$1" || return 1
    test -d "$2" || mkdir -p "$2"
    echo "cmd  : chmod +x ${1}"
    chmod +x "$1"
    echo "cmd  : mv ${1} ${2}"
    mv "$1" "$2"
}

while (($#)); do
    case "$1" in
        -force)
        force=1
        ;;
        *)
        url="$1"
        ;;
    esac
    shift
done

if [[ ! -f /usr/bin/wget ]]; then
    echo "*** wget not found"
    echo "install it with :"
    echo "sudo apt install wget"
    echo "abort..."
    exit 1
fi

if [[ "$EUID" == 0 ]]; then
    destdir="/usr/local/bin/"
fi

if [[ $url != "http"* ]]; then
    echo "usage : appinst \"https://url/to/a_file\""
    echo "usage : appinst -f \"https://url/to/a_file\""
    echo "abort..."
    exit 1
fi

download_file "$url"

if [[ ! -f $filepath ]]; then
    echo "*** download error"
    echo "abort..."
    exit 1
fi

echo "file : $filepath"
filetype=$(file -b "$filepath")
echo "type : $filetype"

if [[ $force != 1 ]] \
&& [[ $filetype != "ELF"* ]] \
&& [[ $filetype != "Bourne-Again shell script"* ]] \
&& [[ $filetype != "Perl script"* ]] \
&& [[ $filetype != "Python script"* ]] \
&& [[ $filetype != "Ruby script"* ]]; then
    echo "*** file is not an ELF file or a bash script"
    echo "abort..."
    exit 1
fi

move_file "$filepath" "$destdir"


